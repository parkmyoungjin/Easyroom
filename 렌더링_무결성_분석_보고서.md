# ë Œë”ë§ ë¬´ê²°ì„± ë¶„ì„ì„ ìœ„í•œ UI ì»´í¬ë„ŒíŠ¸ ë³´ê³ ì„œ

## ğŸ¯ ë¶„ì„ ëª©í‘œ
`AuthProvider`ê°€ ì„±ê³µì ìœ¼ë¡œ ì¸ì¦ì„ ì™„ë£Œí•œ í›„, `userProfile` ë°ì´í„°ë¥¼ ì†Œë¹„í•˜ëŠ” UI ì»´í¬ë„ŒíŠ¸ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì¹˜ëª…ì ì¸ ë Œë”ë§ ì˜¤ë¥˜ë¥¼ ì‹ë³„í•˜ê³  ë°©ì–´ì  ë Œë”ë§ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì—¬ ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ í™•ë³´í•©ë‹ˆë‹¤.

## ğŸ” ë¶„ì„ ê²°ê³¼ ìš”ì•½

### ì£¼ìš” ë°œê²¬ì‚¬í•­
1. **page-content.tsxê°€ ì£¼ìš” ìš©ì˜ì**: `userProfile` ë°ì´í„°ë¥¼ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ì»´í¬ë„ŒíŠ¸
2. **ë°©ì–´ì  ë Œë”ë§ì´ ì´ë¯¸ ì¼ë¶€ ì ìš©ë¨**: ì˜µì…”ë„ ì²´ì´ë‹(`?.`)ê³¼ ì¡°ê±´ë¶€ ë Œë”ë§ ì‚¬ìš©
3. **AtomicProfileTest ì»´í¬ë„ŒíŠ¸**: í…ŒìŠ¤íŠ¸ ëª©ì ì´ì§€ë§Œ `userProfile` ë°ì´í„°ì— ì§ì ‘ ì ‘ê·¼
4. **AuthGatekeeperëŠ” ì•ˆì „í•¨**: ë‹¨ìˆœíˆ `authStatus`ë§Œ í™•ì¸í•˜ì—¬ ë¶„ê¸° ì²˜ë¦¬

---

## 1. ë£¨íŠ¸ ë ˆì´ì•„ì›ƒ: `layout.tsx`

**íŒŒì¼ ê²½ë¡œ:** `src/app/layout.tsx`  
**ë¶„ì„ ëª©í‘œ:** ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìµœìƒìœ„ êµ¬ì¡°ì™€, ì „ì—­ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì–´ë–»ê²Œ ë°°ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

**ì½”ë“œ ì „ë¬¸:**
```typescript
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import '@/app/globals.css';
import Providers from '@/app/providers';
import { Toaster } from '@/components/ui/toaster';
import { ClientPolyfillManager } from '@/lib/polyfills/ClientPolyfillManager';
import { SupabaseProvider } from '@/contexts/SupabaseProvider';
import { AuthProvider } from '@/contexts/AuthContext';
import { AuthToastManager } from '@/components/auth/AuthErrorToast';
import AuthGatekeeper from '@/components/layout/AuthGatekeeper';

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  preload: true,
  fallback: ['system-ui', 'arial'],
  adjustFontFallback: true,
});

export const metadata: Metadata = {
  title: 'íšŒì˜ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ',
  description: 'ê°„í¸í•œ íšŒì˜ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ',
  // ... ë©”íƒ€ë°ì´í„° ì„¤ì •
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ko" suppressHydrationWarning>
      <body className={`${inter.className} min-h-screen bg-background antialiased`}>
        <ClientPolyfillManager enableServiceWorker={true} enablePWAComponents={true}>
          <Providers>
            <SupabaseProvider>
              <AuthProvider>
                <AuthGatekeeper>
                  {children}
                </AuthGatekeeper>
                <AuthToastManager />
                <Toaster />
              </AuthProvider>
            </SupabaseProvider>
          </Providers>
        </ClientPolyfillManager>
      </body>
    </html>
  );
}
```

**ë¶„ì„ ê²°ê³¼:** âœ… **ì•ˆì „í•¨**
- `userProfile` ë°ì´í„°ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- ë‹¨ìˆœíˆ Provider ê³„ì¸µ êµ¬ì¡°ë§Œ ì„¤ì •

---

## 2. ë©”ì¸ í˜ì´ì§€ UI: `page.tsx` ë° `page-content.tsx`

**íŒŒì¼ ê²½ë¡œ:** `src/app/page.tsx` ë° `src/app/page-content.tsx`  
**ë¶„ì„ ëª©í‘œ:** ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ë©”ì¸ í˜ì´ì§€ì˜ êµ¬ì¡°ì™€, `userProfile` ë°ì´í„°ë¥¼ ì†Œë¹„í•  ê°€ëŠ¥ì„±ì´ ìˆëŠ” í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ì‹ë³„

### 2.1 `page.tsx`
```typescript
import { Suspense } from 'react';
import PageContent from '@/app/page-content';
import { Skeleton } from '@/components/ui/skeleton';

const MainPageSkeleton = () => (
  <div className="min-h-screen bg-background">
    {/* ìŠ¤ì¼ˆë ˆí†¤ UI */}
  </div>
);

export default function HomePage() {
  return (
    <Suspense fallback={<MainPageSkeleton />}>
      <PageContent />
    </Suspense>
  );
}
```

**ë¶„ì„ ê²°ê³¼:** âœ… **ì•ˆì „í•¨**
- `userProfile` ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- ë‹¨ìˆœíˆ Suspense ë˜í¼ ì—­í• 

### 2.2 `page-content.tsx` âš ï¸ **ì£¼ìš” ìš©ì˜ì**
```typescript
'use client';

import { useAuth } from '@/hooks/useAuth';
// ... ê¸°íƒ€ imports

export default function PageContent() {
  const { userProfile, signOut, isAuthenticated, isLoading, authStatus } = useAuth();
  const { toast } = useToast();

  // ğŸ” userProfile ì‚¬ìš© ì§€ì ë“¤:

  // 1. í—¤ë” ì˜ì—­ - ì‚¬ìš©ì ì¸ì‚¬ë§
  <p className="mt-2 text-muted-foreground">
    {isAuthenticated() && userProfile?.name
      ? <>ì•ˆë…•í•˜ì„¸ìš”, <span className="font-semibold text-primary">{userProfile.name}</span>ë‹˜!</>
      : 'íšŒì˜ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.'
    }
  </p>

  // 2. ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ë¸”ë¡
  {userProfile && (
    <div className="text-right hidden sm:block">
      <p className="font-semibold">{userProfile.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì'}</p>
      <p className="text-sm text-muted-foreground">{userProfile.department || 'ì†Œì† ì—†ìŒ'}</p>
    </div>
  )}

  // 3. ê´€ë¦¬ì ë©”ë‰´ ì¡°ê±´ë¶€ ë Œë”ë§
  {isAuthenticated() && userProfile?.role === 'admin' && (
    <section>
      <h2 className="text-xl font-semibold mb-4 text-destructive">ê´€ë¦¬ì ë©”ë‰´</h2>
      {/* ê´€ë¦¬ì ë©”ë‰´ ì»´í¬ë„ŒíŠ¸ë“¤ */}
    </section>
  )}
}
```

**ë¶„ì„ ê²°ê³¼:** âš ï¸ **ì ì¬ì  ìœ„í—˜ ìš”ì†Œ ë°œê²¬**

**ìœ„í—˜ ìš”ì†Œ:**
1. **ì˜µì…”ë„ ì²´ì´ë‹ ëˆ„ë½ ê°€ëŠ¥ì„±**: ëŒ€ë¶€ë¶„ `userProfile?.name` í˜•íƒœë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ì–´ ìˆìœ¼ë‚˜, ë³µì¡í•œ ì¡°ê±´ë¬¸ì—ì„œ ì‹¤ìˆ˜ ê°€ëŠ¥ì„±
2. **ì¤‘ì²©ëœ ì¡°ê±´ë¶€ ë Œë”ë§**: `isAuthenticated() && userProfile?.role === 'admin'` ê°™ì€ ë³µì¡í•œ ì¡°ê±´
3. **ê¸°ë³¸ê°’ ì²˜ë¦¬**: `userProfile.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì'` í˜•íƒœë¡œ ì²˜ë¦¬ë˜ì–´ ìˆì–´ ìƒëŒ€ì ìœ¼ë¡œ ì•ˆì „

**í˜„ì¬ ë°©ì–´ ìˆ˜ì¤€:** ğŸŸ¡ **ì¤‘ê°„** (ëŒ€ë¶€ë¶„ ì•ˆì „í•˜ì§€ë§Œ ê°œì„  ì—¬ì§€ ìˆìŒ)

---

## 3. AuthGatekeeper ì»´í¬ë„ŒíŠ¸

**íŒŒì¼ ê²½ë¡œ:** `src/components/layout/AuthGatekeeper.tsx`  
**ë¶„ì„ ëª©í‘œ:** ì¸ì¦ ìƒíƒœì— ë”°ë¥¸ ë Œë”ë§ ë¶„ê¸° ë¡œì§ í™•ì¸

**ì½”ë“œ ì „ë¬¸:**
```typescript
"use client";

import React from 'react';
import { useAuthContext } from '@/contexts/AuthContext';

const FullScreenLoader = () => {
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-background">
      <div className="flex flex-col items-center space-y-4">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <div className="text-sm text-muted-foreground">
          ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...
        </div>
      </div>
    </div>
  );
};

const AuthGatekeeper = ({ children }: { children: React.ReactNode }) => {
  const { authStatus } = useAuthContext();

  console.log('[AuthGatekeeper] Current auth status:', authStatus);

  if (authStatus === 'loading') {
    console.log('[AuthGatekeeper] Showing loading screen');
    return <FullScreenLoader />;
  }

  console.log('[AuthGatekeeper] Rendering children - auth status:', authStatus);
  return <>{children}</>;
};

export default AuthGatekeeper;
```

**ë¶„ì„ ê²°ê³¼:** âœ… **ì™„ì „íˆ ì•ˆì „í•¨**
- `userProfile` ë°ì´í„°ë¥¼ ì „í˜€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- ë‹¨ìˆœíˆ `authStatus`ë§Œ í™•ì¸í•˜ì—¬ ë¡œë”©/ë Œë”ë§ ë¶„ê¸° ì²˜ë¦¬
- ë Œë”ë§ ì˜¤ë¥˜ ê°€ëŠ¥ì„± ì—†ìŒ

---

## 4. ê¸°íƒ€ ì»´í¬ë„ŒíŠ¸ë“¤

### 4.1 AtomicProfileTest ì»´í¬ë„ŒíŠ¸ âš ï¸ **í…ŒìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸ ìœ„í—˜**

**íŒŒì¼ ê²½ë¡œ:** `src/components/test/AtomicProfileTest.tsx`

**ìœ„í—˜ ìš”ì†Œ:**
```typescript
const { user, authStatus } = useAuth();

// ì§ì ‘ì ì¸ user ê°ì²´ ì ‘ê·¼
<div>
  <span className="font-medium">ì‚¬ìš©ì:</span>{' '}
  {user?.email || 'None'}  // âœ… ì•ˆì „í•œ ì˜µì…”ë„ ì²´ì´ë‹
</div>
```

**ë¶„ì„ ê²°ê³¼:** ğŸŸ¡ **ìƒëŒ€ì ìœ¼ë¡œ ì•ˆì „** (í…ŒìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸ì´ë¯€ë¡œ í”„ë¡œë•ì…˜ ì˜í–¥ ì œí•œì )

### 4.2 Mobile Header ì»´í¬ë„ŒíŠ¸

**íŒŒì¼ ê²½ë¡œ:** `src/components/ui/mobile-header.tsx`

**ë¶„ì„ ê²°ê³¼:** âœ… **ì™„ì „íˆ ì•ˆì „í•¨**
- `userProfile` ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- ë‹¨ìˆœí•œ ë„¤ë¹„ê²Œì´ì…˜ ì»´í¬ë„ŒíŠ¸

---

## ğŸš¨ ìµœì¢… ì§„ë‹¨ ë° ê¶Œì¥ì‚¬í•­

### ì§„ë‹¨ ê²°ê³¼
1. **ì£¼ìš” ìš©ì˜ì**: `src/app/page-content.tsx`
2. **ìœ„í—˜ë„**: ğŸŸ¡ **ì¤‘ê°„** (ëŒ€ë¶€ë¶„ ë°©ì–´ì  ì½”ë“œê°€ ì ìš©ë˜ì–´ ìˆìœ¼ë‚˜ ì™„ë²½í•˜ì§€ ì•ŠìŒ)
3. **ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ì‹œë‚˜ë¦¬ì˜¤**: `userProfile` ê°ì²´ëŠ” ì¡´ì¬í•˜ì§€ë§Œ ë‚´ë¶€ ì†ì„±ì´ ì˜ˆìƒê³¼ ë‹¤ë¥¸ í˜•íƒœì¼ ë•Œ

### ğŸ”§ ì¦‰ì‹œ ì ìš© ê¶Œì¥ì‚¬í•­

#### 1. page-content.tsx ê°•í™” ë°©ì•ˆ
```typescript
// í˜„ì¬ ì½”ë“œ (ìœ„í—˜)
{userProfile && (
  <div className="text-right hidden sm:block">
    <p className="font-semibold">{userProfile.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì'}</p>
    <p className="text-sm text-muted-foreground">{userProfile.department || 'ì†Œì† ì—†ìŒ'}</p>
  </div>
)}

// ê¶Œì¥ ê°œì„  ì½”ë“œ (ì•ˆì „)
{userProfile && (
  <div className="text-right hidden sm:block">
    <p className="font-semibold">
      {(userProfile.name && typeof userProfile.name === 'string') 
        ? userProfile.name 
        : 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì'}
    </p>
    <p className="text-sm text-muted-foreground">
      {(userProfile.department && typeof userProfile.department === 'string') 
        ? userProfile.department 
        : 'ì†Œì† ì—†ìŒ'}
    </p>
  </div>
)}
```

#### 2. íƒ€ì… ê°€ë“œ í•¨ìˆ˜ ì¶”ê°€
```typescript
// ì•ˆì „í•œ userProfile ê²€ì¦ í•¨ìˆ˜
const isValidUserProfile = (profile: any): profile is UserProfile => {
  return profile && 
         typeof profile === 'object' &&
         (typeof profile.name === 'string' || profile.name === null) &&
         (typeof profile.department === 'string' || profile.department === null) &&
         (typeof profile.role === 'string' || profile.role === null);
};

// ì‚¬ìš© ì˜ˆì‹œ
{isValidUserProfile(userProfile) && userProfile.name && (
  <span className="font-semibold text-primary">{userProfile.name}</span>
)}
```

#### 3. Error Boundary ì¶”ê°€ (ìµœí›„ì˜ ë°©ì–´ì„ )
```typescript
// src/components/error-boundaries/UserProfileErrorBoundary.tsx
class UserProfileErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error('[UserProfile] Rendering error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return <div>ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>;
    }

    return this.props.children;
  }
}
```

### ğŸ¯ ìµœìš°ì„  ì¡°ì¹˜ì‚¬í•­

1. **page-content.tsxì˜ userProfile ì‚¬ìš© ë¶€ë¶„ì— ì¶”ê°€ íƒ€ì… ê²€ì¦ ì ìš©**
2. **Error Boundaryë¡œ ì „ì²´ í˜ì´ì§€ ë˜í•‘**
3. **ê°œë°œì ë„êµ¬ì—ì„œ userProfile ë°ì´í„° êµ¬ì¡° ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§**

ì´ ë³´ê³ ì„œì˜ ê¶Œì¥ì‚¬í•­ì„ ì ìš©í•˜ë©´, `AuthProvider`ê°€ ì„±ê³µì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì œê³µí•œ í›„ ë°œìƒí•  ìˆ˜ ìˆëŠ” ëª¨ë“  ë Œë”ë§ í¬ë˜ì‹œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.