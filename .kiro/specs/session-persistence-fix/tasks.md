# Implementation Plan

- [x] 1. Remove all custom session management code






  - Delete src/lib/auth/SessionSynchronizationManager.ts completely
  - Delete src/lib/auth/PWASessionManager.ts completely  
  - Delete src/lib/auth/AuthCookieManager.ts completely
  - Remove all imports and references to these managers from AuthContext
  - Clean up any unused utility functions related to custom session management
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 2. Update SupabaseProvider to use auth-helpers standard client creation




  - Modify src/contexts/SupabaseProvider.tsx to import createPagesBrowserClient from @supabase/auth-helpers-nextjs
  - Replace existing client creation logic with createPagesBrowserClient<Database>()
  - Add proper initialization logging to track client readiness
  - Ensure isReady state is properly managed for AuthProvider dependency
  - Test that client is created with proper auth-helpers integration
  - _Requirements: 2.1, 2.3, 4.1, 4.2_

- [x] 3. Completely refactor AuthContext to use single onAuthStateChange listener



  - Remove all SessionSynchronizationManager, PWASessionManager, and AuthCookieManager usage from src/contexts/AuthContext.tsx
  - Replace complex session management with single useEffect containing onAuthStateChange listener
  - Add proper dependency array [supabase] to useEffect to prevent stale closures
  - Add supabase client readiness check before setting up auth listener
  - Implement simple state updates (user, authStatus) based on session presence
  - _Requirements: 2.2, 2.4, 4.2, 4.3, 4.4_

- [x] 4. Implement proper initialization order and race condition prevention





  - Modify AuthContext useEffect to wait for supabase client availability before proceeding
  - Add loading state management that waits for SupabaseProvider readiness
  - Remove premature unauthenticated state setting when client is not ready
  - Add proper logging to track initialization sequence
  - Test that AuthProvider never initializes before SupabaseProvider is ready
  - _Requirements: 1.2, 4.1, 4.3, 4.4_

- [x] 5. Simplify authentication operations to use only auth-helpers patterns





  - Update signInWithMagicLink method to use standard supabase.auth.signInWithOtp without custom session handling
  - Update signOut method to use standard supabase.auth.signOut without custom cookie clearing
  - Remove all manual cookie management from authentication operations
  - Ensure all auth operations rely on onAuthStateChange for state updates
  - Test that authentication operations work seamlessly with middleware
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 5.1_

- [x] 6. Add proper error handling without complex retry logic





  - Implement simple error categorization (network, auth, unknown) in AuthContext
  - Remove complex error recovery strategies and let auth-helpers handle retries
  - Add clear error logging for debugging without exposing sensitive data
  - Ensure errors are displayed to users through existing UI patterns
  - Test error scenarios and verify graceful handling
  - _Requirements: 3.5, 5.2, 5.3, 5.4_

- [x] 7. Update loading states and UI to prevent infinite loading





  - Modify loading state logic to properly transition from loading to authenticated/unauthenticated
  - Ensure loading state is only shown during actual authentication operations
  - Add timeout mechanisms to prevent stuck loading states
  - Update UI components to show appropriate loading indicators
  - Test that users never see infinite "페이지를 준비 중입니다" screens
  - _Requirements: 1.1, 1.3, 4.4, 5.5_

- [x] 8. Test complete authentication flow with auth-helpers integration





  - Write integration tests for login flow using auth-helpers patterns
  - Test session persistence across page refreshes and navigation
  - Verify that middleware can properly parse cookies generated by auth-helpers
  - Test logout flow and session cleanup
  - Verify no race conditions occur during app initialization
  - _Requirements: 1.4, 1.5, 2.2, 2.3, 4.1_

- [x] 9. Validate client-server authentication compatibility






  - Test that client-side authentication produces cookies compatible with server-side middleware
  - Verify protected routes work immediately after authentication
  - Test token refresh scenarios work seamlessly
  - Ensure no "세션이 만료되었습니다" errors occur with valid sessions
  - Validate authentication works consistently across different environments
  - _Requirements: 1.1, 1.4, 2.1, 2.2, 5.1, 5.5_

- [x] 10. Clean up and optimize final implementation






  - Remove any remaining unused imports or code related to custom session management
  - Add proper TypeScript types for all auth-helpers integration points
  - Optimize context value memoization to prevent unnecessary re-renders
  - Add comprehensive logging for debugging authentication issues
  - Perform final testing to ensure all requirements are met
  - _Requirements: 3.4, 4.5, 5.2, 5.3, 5.4, 5.5_